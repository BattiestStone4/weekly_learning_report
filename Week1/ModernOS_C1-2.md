# 现代操作系统第一二章笔记

## 第一章 引论

- 什么是操作系统：

  操作系统有两个基本上独立的任务，即为**应用程序**员提供一个资源集的清晰抽象，并管理这些硬件资源。

  将操作系统看作向应用程序提供基本抽象的概念，是一种**自顶向下**的观点。好的抽象可以把一个任务分为两个可管理部分：一个是关于抽象的定义和实现，另一个是随时调用抽象。

  如：**文件**是I/O设备的一个抽象。

  操作系统用来管理一个复杂系统的各个部分，是一种**自底向上**的观点。资源管理可以使用两种方式实现**多路复用**资源：在时间上复用和在空间上复用。

- 操作系统的历史：

  **第一代**（1945~1955）：真空管和穿孔卡片；

  **第二代**（1955~1965）：晶体管和批处理系统（大型机）；

  **第三代**（1965~1980）：集成电路和多道程序设计；

  **第四代**（1980~至今）：个人计算机；

  **第五代**（1990~至今）：移动计算机。

- 处理器：

   CPU主要工作：取指，解码，执行下一条指令。

   每个CPU都有一套专门指令集，所以不可以将生成的arm程序放在x86处理器上运行，反之亦然。

   寄存器是用来解决访问内存时间长于执行指令的产物。在用来保存变量和临时结果的寄存器外，还存在**程序计数器**：保存将要取出的下一条命令的地址，**堆栈指针**：指向内存中栈区的顶端，**程序状态字**：**在系统调用和I/O中很重要**，包含条件码位，CPU优先级，模式，以及其他控制位。

   模式：**用户态**，只能使用有限的CPU指令。**通常无法使用 I/O 和内存保护相关的指令**；**内核态**：可以使用全部CPU指令和硬件功能。为了从操作系统中获得服务，用户程序必须使用**系统调用**。

   现代CPU引入了多线程与超线程技术，允许CPU在纳秒级的时间尺度里来回切换线程。

- 存储器：

   存储器采用了一种分层次的结构。按照金字塔结构分别为**寄存器**、**高速缓存**、**主存**、**硬盘**。其中金字塔由上到下访问时延和存储容量均变大。

   在高速缓存里，存在L1缓存和L2缓存。**L1缓存**通常用来将已解码的指令调入CPU的执行引擎。对频繁使用的数据字，多数芯片还安排了第二个L1缓存。

   **L2缓存**用来存放进来使用过的若干兆字节的内存字。

   此外存在非易失性的**ROM**（写入后不可修改）以及可擦写的**EEPROM**和闪存（写入速度慢于RAM，因此当作ROM使用）和**CMOS 存储器**，为易失性。耗电较少，通常用于保持当前时间和日期。

- 磁盘：

   机械硬盘是机械装置，存在磁道，扇区，柱面。固态硬盘的数据存储在闪存中。

   许多计算机都支持**虚拟内存**机制，这种机制需要快速映像内存子之，由一个称为**存储器管理单元（MMU）**的部件来完成。

   在多道程序系统中，从一个程序切换到另一个程序，有时又称作**上下文切换**，有必要对来自缓存的所有修改过的块进行写回磁盘操作，并修改MMU中的影响寄存器。这种操作的代价很昂贵。

- I/O设备：

   为管理I/O设备，控制器厂家必须为所支持的操作系统提供**设备驱动程序**，为使用驱动程序，需把驱动程序装入操作系统中，这样其可以在核心态运行。

   将驱动程序装入操作系统的途径：

   - 将内核与驱动程序**重新链接**，然后重启系统（许多 Unix 系统以这种方式工作）；

   - 在操作系统文件中**设置一个入口**，并通知该文件需要一个设备驱动程序，然后重启系统（Windows）；

   - 操作系统在**运行时接受**新的驱动程序并将其安装好。

   每个设备控制器都有少量用于通信的寄存器（可以被**直接映射到操作系统的地址空间**，或通过**专门的 IN 和 OUT 指令**访问），驱动程序会将必要的信息写入这些寄存器中。

   实现**输入输出**的三种方式：

   - **忙等待**：需要占据 CPU，CPU 一直轮询设备直到 I/O 操作完成；
   - **中断**：设备驱动程序在 I/O 操作完成时通过“中断”通知操作系统（异步）；
   - **直接存储器访问**（DMA）：可以控制在内存和某些控制器之间的位流，而无须持续的 CPU 干预（仍需通过“中断”通知 CPU 处理完成）。

- 总线

   最早是ISA，之后到PCI以及现在的PCI express（PCIe）。

- 启动计算机的流程：

   - 主板上BIOS程序在计算机启动的时候开始运行。 

   - 首先检查安装的RAM数量，键盘以及其他基本设备是否已安装并正常响应。

   - 开始扫描PCIe和PCI总线并找出连在上面的所有设备。

   - BIOS通过存储在CMOS存储器中的设备清单来决定启动设备。

   - 启动设备上的第一个扇区（包含一个分区表检查程序）被读入内存并执行。

   - 从活动分区读入第二个启动装载模块。

   - 装载模块被读入操作系统，并启动。

   - 操作系统询问 BIOS 相关设备信息，并启动相应进程。

 - 操作系统概念：

   - 进程：

     **进程**本质上是正在执行的一个程序。与每个进程相关的是**地址空间**。在这个地址空间中，进程可以进行读写。

     与一个进程有关的所有信息，除了该进程自身地址空间的内容以外，均存放在操作系统的一张表中，称为**进程表**。

     一个进程包括：地址空间，以及对应的进程表项。

     进程可以接收“信号”（一般为**软件模拟的硬件中断**），并执行相应的信号处理程序。

     系统管理器授权每个进程一个给定的 UID，表示启动该进程的用户。

   - **地址空间**：

     多道程序系统允许在内存中同时运行多个程序。

     地址空间可能大于也可能小于机器的物理内存（部分装入主存，部分留在磁盘，并在需要时来回交换它们）。

   - 文件：（提供对 I/O 的抽象）

     - **块特殊文件**：由可随机存取块组成的设备，如磁盘等（可以被 `mount` 到当前文件系统中）。
     - **字符特殊文件**：用于打印机、调制解调器和其他接收或输出字符流的设备。
     - **管道**：是一种“虚文件”，可连接两个进程。
     - **输入/输出**：I/O 子系统，用于管理 I/O 设备、
     - **保护**：诸如“文件保护”等安全性问题。这里与rwx标志位有关。
     - **shell**：终端与操作系统之间的接口。



## 第二章 进程与线程

